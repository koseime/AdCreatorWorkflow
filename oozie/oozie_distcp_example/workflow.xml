<workflow-app name="workflow" xmlns="uri:oozie:workflow:0.4">

	<global>
		<job-tracker>${jobTracker}</job-tracker>
		<name-node>${nameNode}</name-node>
	</global>
 
	<start to="distcp_node"/>

	<action name="distcp_node">
		<distcp xmlns="uri:oozie:distcp-action:0.1">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${nameNode}/${targetRawDir}"/>
			</prepare>
			<java-opts>-Xmx4G</java-opts>
			<arg>-Dfs.s3n.awsAccessKeyId=${aws_access_key}</arg>
			<arg>-Dfs.s3n.awsSecretAccessKey=${aws_secret_key}</arg>
			<arg>-m</arg>
			<arg>${numMappers}</arg>
			<arg>${sourceS3Dir}</arg>
			<arg>${targetRawDir}</arg>
		</distcp>
		<ok to="file_collapse_node"/>
		<error to="fail"/>
	</action>

	<action name="file_collapse_node">
		<map-reduce>
			<prepare>
				<delete path="${nameNode}/${targetLzoDir}"/>
			</prepare>
			<streaming>
				<mapper>/bin/cat</mapper>
				<reducer>/bin/cat</reducer>
			</streaming>
			<configuration>
				<property>
					<name>mapred.input.dir</name>
					<value>${targetRawDir}</value>
				</property>
				<property>
					<name>mapred.output.dir</name>
					<value>${targetLzoDir}</value>
				</property>
				<property>
					<name>mapreduce.job.reduces</name>
					<value>${numLzoReducers}</value>
				</property>
				<property>
					<name>mapred.output.compress</name>
					<value>true</value>
				</property>
				<property>
					<name>mapred.output.compression.codec</name>
					<value>com.hadoop.compression.lzo.LzopCodec</value>
				</property>
				<property>
					<name>mapreduce.output.fileoutputformat.compress.type</name>
					<value>BLOCK</value>
				</property>
				<property>
					<name>mapreduce.reduce.memory.mb</name>
					<value>8192</value>
				</property>
			</configuration>
		</map-reduce>
		<ok to="lzoFile_indexer_node"/>
		<error to="fail"/>
	</action>

	<action name="lzoFile_indexer_node">
		<java>
			<main-class>com.hadoop.compression.lzo.DistributedLzoIndexer</main-class>
			<arg>${targetLzoDir}</arg>
		</java>
		<ok to="log_processor_node"/>
		<error to="fail"/>
	</action>


	<action name="log_processor_node">
		<java>
			<prepare>
				<delete path="${nameNode}/${outputDir}"/>
			</prepare>
			<main-class>com.kosei.logs.<YOUR_MAIN_CLASS></main-class>
			<arg>-D</arg>
			<arg>mapreduce.reduce.memory.mb=5120</arg>
			<arg>${targetLzoDir}</arg>
			<arg>${outputDir}</arg>
			<file>kosei-altiscale-0.1.jar#kosei-altiscale-0.1.jar</file>
			<capture-output/>
		</java>
		<ok to="retention_cleanup_node"/>
		<error to="fail"/>
	</action>

	<action name="retention_cleanup_node">
		<fs>
			<delete path="${nameNode}/${cleanupTargetRawDir}"/>
			<delete path="${nameNode}/${cleanupTargetLzoDir}"/>
			<delete path="${nameNode}/${cleanupOutputDir}"/>
		</fs>
		<ok to="counts_checker_node"/>
		<error to="fail"/>
	</action>

	<action name="counts_checker_node">
        <shell xmlns="uri:oozie:shell-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<exec>counts_checker.sh</exec>
			<argument>${sourceS3Dir}</argument>
			<argument>${targetRawDir}</argument>
			<file>counts_checker.sh#counts_checker.sh</file>
			<file>s3-credentials.xml#s3-credentials.xml</file>
			<capture-output/>
		</shell>
		<ok to="decision_node"/>
		<error to="fail"/>
	</action>

	<decision name="decision_node">
		<switch>
			<case to="email_success">${wf:actionData('counts_checker_node')['SUCCESS'] == "TRUE"}</case>
			<case to="email_failed">${wf:actionData('counts_checker_node')['SUCCESS'] == "FALSE"}</case>
			<default to="fail"/>
		</switch>
	</decision>

    <action name="email_success">
        <email xmlns="uri:oozie:email-action:0.1">
			<to>${comma_sep_email_list}</to>
			<subject>KOSEI logs WF SUCCESS - ${date}</subject>
			<body>File Counts match. ALTISCALE: ${wf:actionData('counts_checker_node')['ALTISCALE_COUNT']}   S3: ${wf:actionData('counts_checker_node')['S3_COUNT']}</body>
		</email>
		<ok to="end"/>
		<error to="fail"/>
	</action>
 
    <action name="email_failed">
        <email xmlns="uri:oozie:email-action:0.1">
			<to>${comma_sep_email_list}</to>
			<subject>KOSEI logs WF ERROR - ${date}</subject>
			<body>File Counts do NOT match. ALTISCALE: ${wf:actionData('counts_checker_node')['ALTISCALE_COUNT']}   S3: ${wf:actionData('counts_checker_node')['S3_COUNT']}</body>
		</email>
		<ok to="end"/>
		<error to="fail"/>
	</action>
 
	<kill name="fail">
		<message>DistCP workflow failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
	</kill>
	<end name="end"/>
</workflow-app>

